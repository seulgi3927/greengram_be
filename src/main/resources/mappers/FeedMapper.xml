<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.greengram.application.feed.FeedMapper">
    <select id="findAllLimitedTo">
        SELECT f.feed_id, f.contents, f.location, f.created_at, f.writer_user_id
             , u.uid AS writerUid, u.nick_name AS writerNickName, u.pic AS writerPic
             , fl.feed_id IS NOT NULL AS isLike
             , IFNULL(flc.likeCount, 0) AS likeCount
          FROM feed AS f
         INNER JOIN user AS u
            ON u.user_id = f.writer_user_id
          LEFT JOIN feed_like fl
            ON fl.feed_id = f.feed_id
           AND fl.user_id = #{signedUserId}
          LEFT JOIN (
                SELECT feed_id, COUNT(feed_id) AS likeCount
                  FROM feed_like
                 GROUP BY feed_id
             ) flc
            ON flc.feed_id = f.feed_id
         <where>
             <if test="profileUserId != null and profileUserId > 0">
                 f.writer_user_id = #{profileUserId}
             </if>
             <if test="keyword != null">
                AND (f.contents = #{keyword} OR f.location = #{keyword})
             </if>
         </where>
         ORDER BY f.feed_id DESC
         LIMIT #{startIdx}, #{size}
    </select>

    <select id="findAllPicByFeedId">
        SELECT pic FROM feed_pic
         WHERE feed_id = #{feedId}
    </select>

    <select id="findAllByKeyword">
        SELECT contents AS keyword
          FROM feed
         WHERE contents LIKE '%${keyword}%'
         UNION ALL
        SELECT location
          FROM feed
         WHERE location LIKE '%${keyword}%'
    </select>

</mapper>